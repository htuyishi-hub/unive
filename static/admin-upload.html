<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UR Hub - Academic Registry Upload</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .locked-field { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; }
        .locked-icon { position: absolute; right: 10px; top: 38px; color: #9ca3af; }
        .section-disabled { opacity: 0.5; pointer-events: none; filter: grayscale(100%); transition: all 0.3s ease; }
        .section-active { opacity: 1; pointer-events: auto; filter: grayscale(0%); }
    </style>
</head>
<body class="min-h-screen">

    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-700 rounded flex items-center justify-center text-white font-bold">UR</div>
            <a href="/admin" class="font-semibold text-gray-800 text-lg hover:text-blue-600 transition-colors">Academic Registry</a>
        </div>
        <div class="flex items-center gap-4">
            <span id="adminName" class="text-sm text-gray-600 font-medium">Administrator</span>
            <button onclick="logout()" class="text-sm text-red-600 hover:text-red-800">Logout</button>
        </div>
    </nav>

    <div class="max-w-5xl mx-auto py-10 px-6">
        
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Upload Module</h1>
            <p class="text-gray-500 mt-2">Define academic scope and publish learning materials to the registry.</p>
        </div>

        <!-- Academic Scope Definition Panel -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-blue-600"></div>
            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                Academic Targeting
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- College -->
                <div class="relative">
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">College</label>
                    <select id="collegeSelect" class="w-full border border-gray-300 rounded-md px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors" onchange="loadSchools()">
                        <option value="">Select College...</option>
                    </select>
                    <svg id="collegeLock" class="w-4 h-4 locked-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </div>

                <!-- Program/School -->
                <div class="relative">
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Program / School</label>
                    <select id="schoolSelect" class="w-full border border-gray-300 rounded-md px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors" disabled onchange="checkScopeCompletion()">
                        <option value="">Select Program...</option>
                    </select>
                    <svg id="schoolLock" class="w-4 h-4 locked-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </div>

                <!-- Academic Year -->
                <div class="relative">
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Academic Year</label>
                    <select id="yearSelect" class="w-full border border-gray-300 rounded-md px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors" onchange="loadSemesters()">
                        <option value="">Select Year...</option>
                    </select>
                </div>

                <!-- Year of Study -->
                <div class="relative">
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Year of Study</label>
                    <select id="studyYearSelect" class="w-full border border-gray-300 rounded-md px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors" onchange="checkScopeCompletion()">
                        <option value="">Select Level...</option>
                        <option value="1">Year 1</option>
                        <option value="2">Year 2</option>
                        <option value="3">Year 3</option>
                        <option value="4">Year 4</option>
                        <option value="5">Year 5</option>
                    </select>
                </div>

                <!-- Semester -->
                <div class="relative">
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Semester</label>
                    <select id="semesterSelect" class="w-full border border-gray-300 rounded-md px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors" disabled onchange="checkScopeCompletion()">
                        <option value="">Select Semester...</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Module Details Section -->
        <div id="moduleDetailsSection" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8 section-disabled">
            <h2 class="text-lg font-semibold text-gray-800 mb-6 flex items-center gap-2">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Module Details
            </h2>

            <form id="uploadForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Course Code</label>
                        <input type="text" name="course_code" placeholder="e.g., CSC101" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" required oninput="updateConfirmation()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Course Name</label>
                        <input type="text" name="course_name" placeholder="e.g., Introduction to Computer Science" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" required oninput="updateConfirmation()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Lecturer Name</label>
                        <input type="text" name="lecturer_name" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Module Type</label>
                        <select name="module_type" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" required>
                            <option value="Lecture Notes">Lecture Notes</option>
                            <option value="Past Exam">Past Exam</option>
                            <option value="Assignment">Assignment</option>
                            <option value="Reference">Reference</option>
                            <option value="Guide">Guide</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description <span class="text-xs text-gray-500">(Min 20 chars)</span></label>
                    <textarea name="description" rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" required minlength="20"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Upload File</label>
                        <input type="file" name="file" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required onchange="checkFormValidity()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">External Link (Optional)</label>
                        <input type="url" name="external_link" placeholder="https://" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
            </form>
        </div>

        <!-- Visibility Confirmation Panel -->
        <div id="confirmationPanel" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8 hidden">
            <h3 class="text-sm font-bold text-blue-800 uppercase tracking-wide mb-2">Visibility Confirmation</h3>
            <p class="text-sm text-blue-700">
                This module <strong id="confCourseCode"></strong> will be permanently indexed under:
                <br>
                <span class="block mt-1 pl-4 border-l-2 border-blue-300">
                    <span id="confCollege"></span> &rarr; 
                    <span id="confProgram"></span> &rarr; 
                    Year <span id="confYear"></span> &rarr; 
                    <span id="confSemester"></span> &rarr; 
                    <span id="confAcademicYear"></span>
                </span>
            </p>
        </div>

        <!-- Actions -->
        <div class="flex justify-end gap-4">
            <button type="button" onclick="window.location.href='/admin'" class="px-6 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
            <button type="button" id="publishBtn" onclick="submitModule()" class="px-6 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm" disabled>
                Publish to Registry
            </button>
        </div>

    </div>

    <script>
        const API_BASE = '/api';
        let authToken = localStorage.getItem('ur_admin_token');
        
        // Check auth
        if (!authToken) {
            window.location.href = '/admin-login';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadProfile();
            await loadColleges();
            await loadAcademicYears();
        });

        async function loadProfile() {
            try {
                const res = await fetch(`${API_BASE}/admin/profile`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                document.getElementById('adminName').textContent = data.name;
                
                // Handle Role Locking
                if (data.scope.type === 'college' || data.scope.type === 'program') {
                    const collegeSelect = document.getElementById('collegeSelect');
                    collegeSelect.value = data.scope.college_id;
                    collegeSelect.classList.add('locked-field');
                    collegeSelect.disabled = true;
                    document.getElementById('collegeLock').classList.remove('hidden');
                    await loadSchools(data.scope.college_id);
                }

                if (data.scope.type === 'program') {
                    const schoolSelect = document.getElementById('schoolSelect');
                    // Wait for schools to load
                    setTimeout(() => {
                        schoolSelect.value = data.scope.program; // Assuming program stores ID
                        schoolSelect.classList.add('locked-field');
                        schoolSelect.disabled = true;
                        document.getElementById('schoolLock').classList.remove('hidden');
                        checkScopeCompletion();
                    }, 500);
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function loadColleges() {
            const res = await fetch(`${API_BASE}/colleges`);
            const data = await res.json();
            const select = document.getElementById('collegeSelect');
            if (!select.disabled) {
                data.colleges.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    select.appendChild(opt);
                });
            }
        }

        async function loadSchools(collegeId = null) {
            const cid = collegeId || document.getElementById('collegeSelect').value;
            const select = document.getElementById('schoolSelect');
            select.innerHTML = '<option value="">Select Program...</option>';
            
            if (!cid) {
                select.disabled = true;
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/schools?college_id=${cid}`);
                if (!res.ok) throw new Error('Failed to load programs');
                const data = await res.json();
                
                data.schools.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = `${s.code} - ${s.name}`;
                    select.appendChild(opt);
                });
                
                if (!document.getElementById('schoolLock').classList.contains('hidden')) {
                    // If locked, don't enable
                } else {
                    select.disabled = false;
                }
            } catch (e) {
                console.error(e);
                select.innerHTML = '<option value="">Error loading programs</option>';
            }
        }

        async function loadAcademicYears() {
            const res = await fetch(`${API_BASE}/academic-years`);
            const data = await res.json();
            const select = document.getElementById('yearSelect');
            data.academic_years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y.id;
                opt.textContent = y.name;
                select.appendChild(opt);
            });
        }

        async function loadSemesters() {
            const yearId = document.getElementById('yearSelect').value;
            const select = document.getElementById('semesterSelect');
            select.innerHTML = '<option value="">Select Semester...</option>';
            
            if (!yearId) {
                select.disabled = true;
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/academic-years/${yearId}`);
                if (!res.ok) throw new Error('Failed to load semesters');
                const data = await res.json();
                
                if (data.semesters && data.semesters.length > 0) {
                    data.semesters.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id;
                        opt.textContent = s.name;
                        select.appendChild(opt);
                    });
                    select.disabled = false;
                    checkScopeCompletion();
                } else {
                    select.innerHTML = '<option value="">No semesters found</option>';
                    select.disabled = false;
                }
            } catch (e) {
                console.error(e);
                select.innerHTML = '<option value="">Error loading semesters</option>';
                select.disabled = false;
            }
        }

        function checkScopeCompletion() {
            const college = document.getElementById('collegeSelect').value;
            const school = document.getElementById('schoolSelect').value;
            const year = document.getElementById('yearSelect').value;
            const studyYear = document.getElementById('studyYearSelect').value;
            const semester = document.getElementById('semesterSelect').value;

            const section = document.getElementById('moduleDetailsSection');
            
            if (college && school && year && studyYear && semester) {
                section.classList.remove('section-disabled');
                section.classList.add('section-active');
                updateConfirmation();
            } else {
                section.classList.add('section-disabled');
                section.classList.remove('section-active');
                document.getElementById('confirmationPanel').classList.add('hidden');
            }
        }

        function updateConfirmation() {
            const panel = document.getElementById('confirmationPanel');
            const code = document.querySelector('input[name="course_code"]').value;
            
            if (!code) {
                panel.classList.add('hidden');
                return;
            }

            const collegeText = document.getElementById('collegeSelect').options[document.getElementById('collegeSelect').selectedIndex].text;
            const schoolText = document.getElementById('schoolSelect').options[document.getElementById('schoolSelect').selectedIndex].text;
            const yearText = document.getElementById('yearSelect').options[document.getElementById('yearSelect').selectedIndex].text;
            const studyYearText = document.getElementById('studyYearSelect').options[document.getElementById('studyYearSelect').selectedIndex].text;
            const semesterText = document.getElementById('semesterSelect').options[document.getElementById('semesterSelect').selectedIndex].text;

            document.getElementById('confCourseCode').textContent = code;
            document.getElementById('confCollege').textContent = collegeText;
            document.getElementById('confProgram').textContent = schoolText;
            document.getElementById('confYear').textContent = studyYearText.replace('Year ', '');
            document.getElementById('confSemester').textContent = semesterText;
            document.getElementById('confAcademicYear').textContent = yearText;

            panel.classList.remove('hidden');
            checkFormValidity();
        }

        function checkFormValidity() {
            const form = document.getElementById('uploadForm');
            const btn = document.getElementById('publishBtn');
            const isValid = form.checkValidity();
            btn.disabled = !isValid;
        }

        // Add event listeners to form inputs to re-check validity
        document.querySelectorAll('#uploadForm input, #uploadForm textarea, #uploadForm select').forEach(el => {
            el.addEventListener('input', checkFormValidity);
        });

        async function submitModule() {
            const btn = document.getElementById('publishBtn');
            btn.disabled = true;
            btn.textContent = 'Publishing...';

            const formData = new FormData(document.getElementById('uploadForm'));
            
            // Append academic scope data
            formData.append('college_id', document.getElementById('collegeSelect').value);
            formData.append('school_id', document.getElementById('schoolSelect').value);
            formData.append('program_name', document.getElementById('schoolSelect').options[document.getElementById('schoolSelect').selectedIndex].text);
            formData.append('academic_year_id', document.getElementById('yearSelect').value);
            formData.append('year_of_study', document.getElementById('studyYearSelect').value);
            formData.append('semester_id', document.getElementById('semesterSelect').value);

            try {
                const res = await fetch(`${API_BASE}/admin/modules`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                const data = await res.json();

                if (res.ok) {
                    alert('Module published successfully to the registry!');
                    window.location.reload();
                } else {
                    alert('Error: ' + data.error);
                    btn.disabled = false;
                    btn.textContent = 'Publish to Registry';
                }
            } catch (e) {
                console.error(e);
                alert('Network error occurred.');
                btn.disabled = false;
                btn.textContent = 'Publish to Registry';
            }
        }

        function logout() {
            localStorage.removeItem('ur_admin_token');
            window.location.href = '/admin-login';
        }
    </script>
</body>
</html>